# 5. 单元测试

## 5.1 概述

目前，软件测试分为 4 个阶段：  

单元测试 >> 集成测试 >> 系统测试 >> 验收测试  

**单元测试** 又称模块测试，指将软件设计的最小单元进行功能、性能、接口和设计约束等进行正确性检验。  

**软件单元** 在定义中，指软件设计说明中一个可独立测试的元素，是程序中一个逻辑上独立的部分，它不能再分解为其他软件成分。实践上，指软件源代码中单个函数，源文件或类。  

单元测试的内容包括：单元的内部结构、单元的功能和可观测的行为。  

## 5.2 单元测试内容

根据检查列表 (Checklist) 通过各种测试方法找到错误。  

单元测试主要对模块的五个基本特征进行评价：  

* 重要的执行路径。  
* 错误处理。  
* 模块接口。  
* 局部数据结构。  
* 边界条件。  

### 5.2.1 模块独立执行路径测试

检查每一条独立执行路径的测试。保证每条语句至少执行一次。  

> Checklist：  
>  
> * 算符优先级
> * 混合类型运算
> * 变量初值
> * 精度
> * 表达式符号
> * 循环条件
> * 其它

### 5.2.2 模块局部数据结构测试

检查局部数据结构完整性。  

> Checklist：  
>  
> * 不适合或不相容的类型说明
> * 变量初值
> * 变量初始化或默认值
> * 未被使用过或不正确的变量名
> * 出现上溢或下溢和地址异常
> * 其它

### 5.2.3 模块接口测试

检查模块接口是否正确。  

> Checklist
>  
> * 输入的实际参数与形式参数是否一致（个数、属性、量纲）
> * 调用其它模块的实际参数与被调模块的形参是否一致（个数、属性、量纲）
> * 全程变量的定义在各模块是否一致
> * 外部输入、输出（文件、缓冲区、错误处理）
> * 其它

### 5.2.4 模块边界条件测试

检查临界数据处理的正确性。  

> Checklist：  
>  
> * 普通合法数据的处理
> * 普通非法数据的处理
> * 边界值内合法边界数据的处理
> * 边界值外非法边界数据的处理
> * 其它

### 5.2.5 模块各条错误处理路径测试

预见、预设的各种出错处理是否正确有效。  

> Checklist：  
>  
> * 输出的出错信息难以理解
> * 记录的错误与实际不相符
> * 程序定义的出错处理前系统已介入
> * 异常处理不当
> * 未提供足够的定位出错的信息
> * 其它

## 5.3 单元测试环境

基本单元本身不是一个独立的程序，自己不能运行，要靠其他部分来 **调用** 和 **驱动** 。  

**驱动模块** (Driver) 是被测基本单元的主程序，它接收测试数据，并把数据传送给被测单元，最后输出实测结果。  
即对底层或子层模块进行测试所编写的调用这些模块的程序。  

**桩模块** (Stub) 用来代替被测基本单元调用的其它基本单元。  
即对顶层或上层模块进行测试时所编写的替代下层模块的程序。  

## 5.4 单元测试策略

单元测试策略包含：  

* 静态测试  
* 单元结构测试  
* 单元功能测试  

### 5.4.1 静态测试

不运行被测试程序，通过以下三步通过检查、阅读进行代码分析：  

* 代码走查 (Code Walkthrough)  
  采用讲解、讨论和模拟运行的方式进行的查找错误的活动。  
  应注意：  
  * 引导小组成员在走查前通读设计和编码。限时，避免跑题。  
  * 发现问题适当记录，避免现场修改。  
  * 检查要点是代码是否符合标准和规范，是否有逻辑错误。  
* 代码审查 (Code Inspection)  
  采用讲解、提问方式进行，一般有正式的计划、流程和结果。主要采用 **缺陷检查表** 。  
  应注意：  
  * 以会议形式，制定会议目标、流程和规则，结束后要编写报告。  
  * 按缺陷检查表逐项检查。  
  * 发现问题适当记录，避免现场修改。  
  * 发现重大缺陷，改正后会议需要重开。  
  * 检查要点是缺陷检查表，所以该表要根据项目不同不断积累完善。  
* 代码评审 (Code Review)
  通常在审查会后进行，审查小组根据记录和报告进行评估。  
  应注意：  
  * 充分审查了所规定的代码，并且全部编码准则被遵守。  
  * 审查中发现的错误已全部修改。  

走查与审查的比较：  

项目 | 走查 | 审查
:---:|----|---
准备 | 通读设计和编码 | 应准备好需求描述文档、程序设计文档、程序的源代码清单、代码编码标准和代码缺陷检查表
形式 | 非正式会议 | 正式会议
参加人员 | 开发人员为主 | 项目组成员包括测试人员
主要技术方法 | 无 | 缺陷检查表
注意事项 | 限时、不要现场修改代码 | 限时、不要现场修改代码
生成文档 | 会议记录 | 静态分析错误报告
目标 | 代码标准规范，无逻辑错误 | 代码标准规范，无逻辑错误

### 5.4.2 单元结构测试

单元结构测试关注的是代码内部的执行情况，关注代码执行的覆盖率。  
单元结构测试方法主要采用白盒测试。  

### 5.4.3 单元功能测试

单元功能测试方法主要采用黑盒测试。  

单元测试可以采取如下策略进行：  

* 自顶向下的单元测试  
  * 方法：先对最顶层的基本单元进行测试，把所有调用的单元做成桩模块。然后再对第二层的基本单元进行测试，使用上面已测试的单元做驱动模块。依此类推直到测试完所有基本单元。  
  * 优点：在集成测试前提供早期的集成途径.在执行上和详细设计的顺序一致.不需要开发驱动模块。  
  * 缺点：随着测试的进行，测试过程越来越复杂，开发和维护成本增加。  
  * 总结：比孤立单元测试的成本高很多，不是单元测试的一个好的选择。  
* 自底向上的单元测试  
  * 方法：先对最底层的基本单元进行测试，模拟调用该单元的单元做驱动模块。然后再对上面一层进行测试，用下面已被测试过的单元做桩模块。依此类推，直到测试完所有单元。  
  * 优点:在集成测试前提供系统早期的集成途径。不需要开发桩模块。  
  * 缺点:随着测试的进行，测试过程越来越复杂。  
  * 总结:比较合理的单元测试策略，但测试周期较长。  
* 孤立单元测试  
  * 方法:不考虑每个单元与其它单元之间的关系，为每个单元设计桩模块或驱动模块。每个模块进行独立的单元测试。  
  * 优点:简单、容易操作，可达到高的结构覆盖率。  
  * 缺点：不提供一种系统早期的集成途径。  
  * 总结:最好的单元测试策略。  
