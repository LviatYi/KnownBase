# 4. 数据库应用

## 4.1 关系数据库语言 SQL

### 4.1.1 SQL 概述

更多教程请参考：

[W3Schools | SQL](https://www.w3schools.com/sql/)

[菜鸟教程 | SQL](https://www.runoob.com/sql/sql-tutorial.html)

#### 4.1.1.1 SQL 的特点

- **综合统一** 数据定义、数据操纵、数据控制于一体
- **高度非过程化** 内部逻辑由 DBMS 实现
- **面向集合的操作方式**
- **以同一种语法结构提供两种使用方法** 嵌入或自含
- **语言简洁，易学易用**

#### 4.1.1.2 SQL 基本概念

SQL 支持数据库的三级模式结构。

![SQL 三级结构](../pic/SQL%20Structure.svg)

##### 基本表

**基本表** 是独立存在于数据库中的表，是「实表」。

一个关系对应一个基本表，一个或多个基本表对应一个存储文件。

##### 视图

**视图** 是从一个或几个基本表（或视图）导出的表，是「虚表」。

其本身不独立存在于数据库中，数据库中只存放视图的定义而不存放视图对应的数据，这些数据仍存放在导出视图的基本表中。当基本表中的数据发生变化时，从视图中查询出来的数据也随之改变。

##### 存储文件

数据库的所有信息都保存在 **存储文件** 中。数据库是逻辑的，存储文件是物理的。用户操作的数据库，实际上最终都是操作存储文件。一个基本表可以用一个或多个存储文件存储，存储文件的物理结构对用户是透明的

##### 索引

- 物理顺序 表中的记录按其输入的时间顺序存放。
- 逻辑顺序 表文件中的记录按某个或某些属性进行排序，以实现对表记录的快速查询。

**索引** 是根据索引表达式的值进行逻辑排序的一组指针，它可以实现对数据的快速访问。  
索引是关系数据库的内部实现技术，属于 **内模式** ，被存放在存储文件中。

#### 4.1.1.3 SQL 语言的组成

- **数据定义语言 DDL** (Data Definition Language) 定义数据库结构，包括定义表、视图和索引等。
- **数据操纵语言 DML** (Data Manipulation Language) 主要包括查询、插入、删除和修改数据库中数据的操作。
- **数据控制语言 DCL** (Data Control Language) 包括对数据库的安全性控制、完整性控制以及对事务的定义、并发控制和恢复等。

#### 4.1.1.4 SQL 语句分类

- **数据定义** 创建、更新和撤销模式及其对象。  
  如 CREATE DROP ALERT
- **数据查询** 进行数据库的数据查询。  
  如 SELECT
- **数据操纵** 完成数据库的数据更新。  
  如 INSERT UPDATE DELET
- **数据控制** 进行数据库的授权、事务管理和控制。  
  如 GRANT REVOKE COMMIT ROLLBACK

### 4.1.2 SQL 语言的数据类型

SQL 语言在定义表中各属性时，要求指明其 **数据类型** 和 **长度** 。  
SQL 语言提供了一些基本数据类型，而不同 RDBMS (Relational Database Management System) 所支持的数据类型不完全相同，使用时请阅读具体 RDBMS 的相关文档。

[SQL 数据类型 | W3Schools](https://www.w3schools.com/sql/sql_datatypes.asp)

### 4.1.3 SQL 数据定义

#### 4.1.3.1 模式定义

**模式定义** 即定义一个存储空间。  
一个 SQL 模式由模式名、用户名或账号来确定。在这个空间中可以进一步定义该模式包含的数据库对象，如基本表、视图、索引等。

> SQL3 标准的模式定义语句是 `CREATE SCHEMA` 。但由于「模式」这个名称较抽象，多数 RDBMS 不采用该名词，而采用「数据库」这一名称。这个数据库概念将数据库视为许多对象的容器。  
> 因此虽然在 SQL 标准中没有 `CREATE DATABASE` 语句，但多数 SQL 产品都支持 `CREATE DATABASE` 创建数据库的语句。

包括如下操作：

- [定义数据库](./sqlSyntax.md#CreateDatabase)
- [使用数据库](./sqlSyntax.md#UseDatabase)
- [修改数据库](./sqlSyntax.md#AlterDatabase)
- [删除数据库](./sqlSyntax.md#DropDatabase)

#### 4.1.3.2 基本表定义

**基本表定义** 的实质就是定义表结构及约束等。

包括如下操作：

- [定义基本表](./sqlSyntax.md#CreateTable)
- [修改基本表](./sqlSyntax.md#AlterTable)
- [删除基本表](./sqlSyntax.md#DropTable)

#### 4.1.3.3 索引定义

**索引** 能够提高数据查询速度。

查询是数据库使用最频繁的操作，如何能更快地找到所需数据，是数据库的一项重要任务。

建立索引会有一定代价：

- 占用存储空间。
- 当表中数据记录发生插入、删除、更新等操作，索引需要同步更新，维护成本高。
- 索引开销大。

索引可以分为：

- **聚簇索引** (Clustered Index)  
  对表的物理数据页中的数据 **按索引关键字** 进行排序，然后重新存储到磁盘上。  
  聚簇索引与数据是一体的，因此最多只有一个聚簇索引。  
  代价更高。
- **非聚簇索引** (Nonclustered Index)  
  具有完全独立于数据的索引结构，它不将物理数据页中的数据按索引关键字排序。  
  默认选择。

当索引建立在多个列上时，该索引称为复合索引。

索引一经建立，就由 RDBMS 自动维护与使用，开发者无须干预。

包括如下操作：

- [定义索引](./sqlSyntax.md#CreateIndex)
- [删除索引](./sqlSyntax.md#DropIndex)

#### 4.1.3.4 视图定义

**视图** 是从一个或多个基本表（或视图）导出的表。

- 视图是一个虚表，数据库中只存储视图的定义，而不存放视图对应的数据，这些数据仍然存放在原来的基本表中。
- 视图是数据库系统提供给用户以多种角度观察数据库中数据的重要机制。

视图作为外模式的表现具有如下优点：

- 为用户集中数据，简化数据查询和处理。  
  有时用户所需要的数据分散在多个表中，定义视图可将它们集中在一起，从而方便用户的数据查询和处理。
- 屏蔽数据库的复杂性。  
  用户不必了解复杂的数据库表结构，并且数据库表的更改也不影响用户对数据库的使用。
- 简化用户权限管理。  
  只需授予用户使用视图的权限，而不必指定用户只能使用表的特定列，增加了安全性。
- 便于数据共享。  
  各用户不必都定义和存储自己所需的数据，可共享数据库的数据，同样的数据只需存储一次。
- 可以重新组织数据以便输出到其他应用程序中。

使用视图有如下注意事项：

- 只有在当前数据库中才能创建视图。
- 视图的命名必须遵循标识符命名规则。视图不能与表同名，且对每个用户视图名必须是唯一的，即对不同用户，即使是定义相同的视图，也必须使用不同的名字。
- 不能在视图上建立索引。

包括如下操作：

- [定义视图](./sqlSyntax.md#CreateView)
- [修改视图](./sqlSyntax.md#AlterView)
- [删除视图](./sqlSyntax.md#DropView)

### 4.1.4 SQL 数据查询

#### 4.1.4.1 SELETE 语句结构

数据查询常使用 [`SELECT`](./sqlSyntax.md#Select) 语句。

#### 4.1.4.2 单表查询

##### 选择列

选择表中的部分或全部列形成结果表。

选择关系表的列相当于关系代数的 **投影运算** 。

##### 选择行

选择表中的部分或全部元组形成结果表。

选择关系表的列相当于关系代数的 **选择运算** 。

一般通过 `WHERE` 语句实现。

构成 `WHERE` 子句的条件表达式的运算符也称 **谓词** 。

谓词包括：

| 查询条件 | 谓词                                       |
| -------- | ------------------------------------------ |
| 比较运算 | `<=` `<` `=` `>=` `>` `<> OR !=` `!<` `!>` |
| 指定范围 | `BETWEEN AND` `NOT BETWEEN AND`            |
| 确定集合 | `IN` `NOT IN`                              |
| 字符匹配 | `LIKE` `NOT LIKE`                          |
| 空值比较 | `IS NULL` `IS NOT NULL`                    |
| 逻辑运算 | `AND` `OR` `NOT`                           |

可以将多个判定运算的结果通过逻辑运算符再组成更为复杂的查询条件。

##### 排序

##### 聚合函数

##### 对查询结果分组

##### 使用 `HAVING` 子句进行筛选

#### 4.1.4.3 连接查询

#### 4.1.4.4 嵌套查询

#### 4.1.4.5 集合查询

#### 4.1.4.6 视图查询

### 4.1.5 SQL 数据更新
