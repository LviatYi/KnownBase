# 行为树 Behavior Tree——树形行为控制器

## 行为树与有限状态自动机

**行为树** (**BT**,Behavior Tree) 是一种控制 AI 实体决策流程的分层结点树，通过结点完成流程控制与行为表现。

用于 Ai 行为编程的还有其他方法，其中 **有限状态自动机** (**FSM**,finite state machine) 就极为常用。FSM 拥有有限数量的状态，状态之间在某种条件下允许切换。

与 FSM 相比，BT 具有相当大的优越性：

- **扩展性**  
  FSM 的状态之间处于强耦合的关系。每当添加一个新的状态，就需要考虑其与所有现存状态的联系，并定义转换条件。
- **复用性**  
  FSM 是难以复用的，而在 BT 中，转换条件、行为作为结点或子树都是可复用的。
- **维护性**  
  由于强耦合性，对 FSM 状态的修改牵扯其他状态。而 BT 的树形结构决定了修改被限定在了某个子树的范围内。

## 行为树结构

对于每个行为树结点，每次触发都称为一次 tick，且都有至少三种返回值：

- **成功**  
  行为成功。  
- **失败**  
  行为失败。  
- **运行**
  行为仍在运行。

对于所有行为树结点，共有三种主要类型：

- **复合** Composite  
  - 可以拥有一个或多个子结点的结点。
  - 以顺序或随机执行其中一个或多个子结点。
  - 返回值由子结点返回值决定。
  - 处理子项时将返回 **运行**。
- **装饰** Decorator  
  - 可以拥有至多一个子结点。
  - 根据条件运行指定次数或终止子结点。
  - 返回值根据子结点结果转换而来。
- **叶子** Leaf  
  - 不可拥有子结点。
  - 决定行为，直接返回返回值。

### 复合结点

复合结点主要包含：

- **序列** Sequence  
  - 序列结点将按随机或非随机的顺序遍历访问每个子结点。
  - 所有结点返回成功时返回成功。
- **选择器** Selector  
  - 选择器结点将按随机或非随机的顺序访问每个子结点，直到达到成功。
  - 任意结点返回成功时返回成功。

### 装饰器结点

装饰器结点主要包含：

- **逆变器** Inverter  
  - 反转子结点返回值。
- **成功器** Succeeder  
  - 无论如何返回成功。
- **中继器** Repeater  
  - 子结点返回时重新处理子结点。可用于重复一定数量。
- **Util**  
  - 重新处理子结点，直到返回成功或失败。
  
### 叶子结点

叶子结点决定了行为。一般需要实现两个特定的函数：

- `init` 在首次由父节点访问时调用。
- `process` 行为，返回成功、失败或运行。

### 数据上下文

行为树允许创建数据上下文，以传递参数信息。
